<!DOCTYPE html>
<html>

<head>
    <title>OCR APP</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no, minimal-ui">
    <!-- meta name="apple-mobile-web-app-capable" content="yes" -->
    <link rel="stylesheet" href="index.css" />
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/naptha/tesseract.js/1.0.7/dist/tesseract.js"></script>
    <script src="data.js"></script>
    <script>
        (function() {
            Tesseract
                .recognize("u.jpg", {
                    lang: 'jpn'
                })
                .progress(function(p) {
                    $("#msg").text('æº–å‚™ä¸­ğŸ¹ <' + p.status + ": " + (100 * p.progress).toFixed(1) + '%>')
                })
                .then(function(result) {
                    $("#msg").text('æº–å‚™å®Œäº†ğŸ¸')
                });
        }());
    </script>
</head>

<body>
    <div align="center">
        <video id="player" controls autoplay playsinline></video>
        <canvas id="canvas" width="300" height="100"></canvas>
        <div class="button">
            <button id="capture">æ—¥æœ¬èªã‚’æ’®å½±ã™ã‚‹</button>
        </div>
        <div class="button">
            <button id="captureeng">Capture English</button>
        </div>
        <div id="msg" align="center"></div>
        <canvas id="snapshot" width="300" height="100"></canvas>
        <br>
        <script>
            var video = document.getElementById("player"),
                canvas = document.getElementById("canvas"),
                ctx = canvas.getContext("2d");
            requestAnimationFrame(draw);

            function draw() {
                canvas.width = 300;
                canvas.height = 100;
                ctx.drawImage(video, 100, 300, 600, 200,
                    0, 0, 300, 100);
                imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    ave = (data[i + 0] + data[i + 1] + data[i + 2]) / 3;
                    data[i + 0] =
                        data[i + 1] =
                        data[i + 2] = (ave > 128) ? 255 : 0;
                    data[i + 3] = 255;
                }
                ctx.putImageData(imgData, 0, 0);
                requestAnimationFrame(draw);
            }
            function search(query) {
              // å…¥åŠ›ã®åˆ†å‰²
              splitter = query.split('');
              //ã‚¹ã‚³ã‚¢æ ¼ç´
              var result={};

              splitter.forEach(function(moji) {
                humans.forEach(function(human) {
                try{
                  if (~human.name.indexOf(moji)) {
                    if(human.name in result){
                      const tmpname=human.name
                      if (human.name.lastIndexOf(moji) > result[human.name].last) {
                        result[human.name].score+=10;
                        result[human.name].last=human.name.indexOf(moji);
                      }else{
                        result[human.name].score+=1;
                      }
                    }else{
                      //result[human.name]=10;
                      //result[human.last]=human.name.indexOf(moji);

                      result[human.name]={last:human.name.indexOf(moji),score:10}
                    }
                  }
                  }catch(e){
                    }
                });
              });
              var clean_result=[];
              for (let i in result){
              clean_result.push({name:i,scor:result[i].score/i.length});
              }
              clean_result.sort(function(a,b){
              if(a['scor']>b['scor']){return -1;}
              else{return 1;}
              }
              )
              console.log(clean_result);
              console.log(result);
              try{
              return clean_result[0]['name']+" ç‚¹æ•°ã¯"+ clean_result[0]['scor']+'<br>'
              + clean_result[1]['name']+" ç‚¹æ•°ã¯"+ clean_result[1]['scor']+'<br>'
              + clean_result[2]['name']+" ç‚¹æ•°ã¯"+ clean_result[2]['scor']+'<br>';
              }catch(e){
              return e
              }
            }

            search('å¤ªé™½ã®åŒ–èº«ã‚¢ãƒã‚¿ãƒ¼ä¸¸ çŠ¬çŒ¿')
            search('å²¡ã€€åƒã€€æ˜')

            var snapshotCanvas = document.getElementById('snapshot');
            var captureButton = document.getElementById('capture');
            var captureButtoneng = document.getElementById('captureeng');
            var snapshotButton = document.getElementById('snapshotbutton');
            var handleSuccess = function(stream) {
                video.srcObject = stream;
            };
            var num = 1;

            captureButton.addEventListener('click', function() {
                var context = snapshot.getContext('2d');
                context.drawImage(video, 100, 300, 600, 200, 0, 0, snapshotCanvas.width,
                    snapshotCanvas.height);
                const url = snapshot.toDataURL("image/png");
                Tesseract
                    .recognize(url, {
                        tessedit_char_whitelist: 'ã€…äºœé˜¿æ„›è‘µèŒœæ¸¥èŠ¦æ¢“çµ¢ç¶¾å®‰æä¼Šä¾å¨æƒŸè¡£äº•è‚²éƒç£¯ä¸€ç¨²å®‡ç¾½é›¨éµœç¢“è‡¼æµ¦å½±æ „æ°¸è‹±è¡›è© ç›Šæ‚¦è¶Šæ¦å††åœ’è‹‘é å¡©å¤®å¥¥æ¨ªæ¬§å²¡æ²–è»å±‹ä¹™æ©éŸ³ä¸‹ä½³åŠ å¯å˜‰å¤å®¶æœæ­Œæ²³èŠ±è¯æˆ‘èŠ½è³€é›…ä»‹ä¼šæµ·çš†çµµå¤–å£æŸ¿è¦šè§’å­¦ç¬ æ¨«æ¢¶è‘›æ¤›éŒä¹¾å·»å®Œå¯›å¹¹æŸ‘ç’°è²«é‘‘é–“é–¢ä¸¸å²¸å·Œå²©å–œåŸºå¸Œæ¯…å­£ç¨€ç´€è¨˜è²´èµ·è¼é¬¼äº€ç¾©èŠå‰æ©˜ä¹…åŠå®®å¼“å±…äº¨äº«äº¬åŒ¡å–¬å¼·æ­æ©‹èˆˆéƒ·éŸ¿æšç‰æ¡å‹¤å‡æ¬½ç´è¿‘é‡‘éŠ€ç–çŸ©ç©ºçªªç†Šæ —æ¡‘å›è–«éƒ¡å•“åœ­å½¢æµæ…¶æ•¬æ™¯æ¡‚ç¶™æ½”çµæœˆå¥å…¼å‰£å …å»ºæ†²ç ”è¦‹è¬™è³¢é¡•å…ƒåŸæºç„å¤å·±æˆ¸è‚¡èƒ¡è™äº”ä¼å¾å¾Œå¾¡æ‚Ÿæªå…‰å…¬åŠŸåšå£å‘å¥½å­å®å·¥å·§å¹¸åºƒåº·å¼˜æ’æ™ƒæ›´æ±Ÿæµ©æºç”²ç´…ç´˜è€•è’è¡Œè¬›è²¢é¦™é«˜å‰›åˆå…‹å›½é»’ä»Šæ ¹ç´ºä½æ²™ç ‚å“‰å¦»å½©æ–ç´°èœå‚é˜ªæ¦Šå’²å´ä½œæ¡œç¬¹é®«ä¸‰å±±å¸å²å—£å››å£«å­å¸‚å¿—æ–½ææ°ç´«è©©é£¼å…å¯ºæŒæ™‚æ¬¡æ»‹æ²»æ±é¹¿å®é›«ä¸ƒå®¤å®Ÿç¯ æŸ´ç´—è‹¥å–å®ˆæ‰‹æœ±ç‹©ç é…’é¦–å¯¿æ¨¹å‘¨å®—ä¿®ç§€ç§‹èˆŸä½å……åæ¸‹é‡æ·‘å‡ºä¿Šå³»æ˜¥é§¿æ·³æ½¤ç´”é †åˆæ‰€æ¸šç·’è«¸åŠ©å‹åŒ å°†å°å°šåº„å½°æŠ„æ˜‡æ˜Œæ˜­æ™¶æ¾æ¢¢æ²¼æ¸‰ç…§çœç¥¥ç« ç´¹ä¸Šä¸ˆåŸå ´å¸¸æ¡è­²æ¤ç¹”å°»ä¼¸ä¿¡å¿ƒæ…æ–°æ™‹æ£®æ·±çœŸç¥ç§¦ç´³è‡£é€²äººä»å°‹è«é ˆå¹æ°´ç¿ ç‘å´‡æ•°é››æ‰è…æ¾„ä¸–ç€¬æˆæ”¿æ˜Ÿæ™´æ­£æ¸…ç”Ÿç››ç²¾è–è¥¿èª èª“é’é™æ–‰çŸ³èµ¤ç¯€é›ªåƒå®£å·æ³‰æµ…æŸ“èˆ¹å‰å–„æ›½ç´ å‰µåŒå€‰å¥æ—©ç›¸è¡è‰è’¼å¢—è”µé€ å‰‡è¶³æ‘å¤šå¤ªæ³°è¢‹ä»£å¤§æ»å“å®…æ‹“æ²¢é”è¾°æ£šè°·ä¸¹ç«¯ç”·çŸ¥åœ°æ™ºæ± ç½®ç¯‰ç«¹ä¸­ä»²å®™å¿ çŒªæš¢æœç”ºé•·é³¥ç›´é™³æ´¥æ¤é€šå¡šæ§»è¾»æ¤¿åªç´¬çˆªé¶´è²å ¤å®šåº­ç¦æ‘˜çš„å“²å¾¹é‰„å…¸å¤©æ·»ç”°æ–—æ¸¡ç™»éƒ½åŠªåœŸå”å³¶å¶‹æ±æ¡ƒæ£Ÿæ¹¯ç¯å½“ç­‰ç­’è—¤é ­å ‚ç³é“å¾³ç¯¤å¯…æ•¦å¥ˆé‚£å†…å‡ªé‹å—æ¥ é›£äºŒæ—¥å…¥å¿å¯§å¹´ä¹ƒä¹‹ç´æ³¢é¦¬æ¢…è©ä¼¯åšæŸç™½ç²•è¿«è‚‡å¹¡ç•‘ç• å…«éš¼ä¼´åŠå¸†æ¿æ±ç¹ç¯„é£¯å¦ƒæ–æ¯”è‚¥é£›æ¨‹å°¾ç¾å½¦å§«ç™¾è‹—è›­æµœæ•ç“¶å¤«å¯Œå†¨å¸ƒæ‰¶æ•·æ­¦èˆéƒ¨æ¥“é¢¨ä¼æœç¦æ·µåˆ†æ–‡å¹³ä¸¦ç±³ç¢§ç‰‡è¾ºå‹‰ä¿æ­©ç”«è¼”ç©‚æš®å³°æ–¹æœ‹æ³•èŠ³èŒè¨ªè±Šé‚¦æˆ¿æœ›åŒ—ç‰§ç¦å €æœ¬éº»å¦¹ä¿£åˆæœ«æº€å‘³æœªå·³æ¹Šç¨”å¦™æ°‘å‹™å¤¢æ¤‹åæ˜é³´èŒ‚æ¯›çŒ›æœ¨ç›®é–€ä¹Ÿè€¶é‡å¼¥çŸ¢é–æŸ³è«­å”¯ä½‘å„ªå‹‡å‹æ‚ æœ‰æŸšç”±ç¥è£•é›„å¤•ä¸å®¹æšæ´‹è‘‰è¦é¥é™½ç¿¼ç¾…æ¥é ¼è½åµè—è˜­åˆ©ææ¢¨ç†ç’ƒé‡Œé™¸å¾‹ç«‹ç‰ç•™éš†ç«œé¾äº®æ¶¼è‰¯é¼é‡åŠ›ç·‘å€«æ—è¼ªç‘ ä»¤æ€œç²ç¤¼éˆ´éº—æ‹æ†è“®å‘‚è·¯éœ²æœ—è€éƒå…­å’Œè„‡äº˜å‡›åœ‹å»£æ æ«»æ¸•æ»‰æ¾¤æ¾ªæ¿±çœé½‹ç¨Ÿç©°ç­°ç¿”èŒ‰è‰è«é‚Šé¢¯é™å‡œ',
                        lang: 'jpn'
                    })
                    .progress(function(p) {
                        $("#msg").text(p.status + ": " + p.progress)
                    })
                    .then(function(result) {
                        console.log(result)
                        $("#msg").text("Progress Complete")
                        var elem = document.createElement('div');
                        elem.innerHTML = "<div id=" + num + " style='width:300px; background-color:#EEEEEE'><img src=" + url + " /></div><br>"
                        var parent = document.getElementById("results");
                        parent.insertBefore(elem, parent.firstChild);
                        var numdiv = document.getElementById(num);
                        var msg = document.createElement('div');
                        //msg.innerHTML = result.text;

                        msg.innerHTML = result.text + ' :<br>'+search(result.text);


                        numdiv.appendChild(msg);
                        num += 1;
                    });
            });
            captureButtoneng.addEventListener('click', function() {
                var context = snapshot.getContext('2d');
                context.drawImage(video, 100, 300, 600, 200, 0, 0, snapshotCanvas.width,
                    snapshotCanvas.height);
                const url = snapshot.toDataURL("image/png");
                Tesseract
                    .recognize(url, {
                        lang: 'eng'
                    })
                    .progress(function(p) {
                        $("#msg").text(p.status + ": " + p.progress)
                    })
                    .then(function(result) {
                        console.log(result)
                        $("#msg").text("Progress Complete")
                        var elem = document.createElement('div');
                        elem.innerHTML = "<div id=" + num + " style='width:300px; background-color:#EEEEEE'><img src=" + url + " /></div><br>"
                        var parent = document.getElementById("results");
                        parent.insertBefore(elem, parent.firstChild);
                        var numdiv = document.getElementById(num);
                        var msg = document.createElement('div');
                        msg.innerHTML = result.text;
                        numdiv.appendChild(msg);
                        num += 1;
                    });
            });
            var front = false;
            var constraints = {
                audio: false,
                video: {
                    width: 1920,
                    height: 1080,
                    facingMode: (front ? "user" : "environment")
                }
            };
            navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess);
        </script>
    </div>
</body>
<div id="results" align="center"></div>

</html>

